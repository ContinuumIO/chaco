window.export_data = {"83947888": {"component_grid": [["83947984", "83992944", "84750896", "84857584"], ["85431216", "85529712", "85648592", "86205840"], ["86320720", "86877968", "86988752", "87091248"], ["87656688", "87771568", "88332912", "88435504"]], "height": 620, "width": 620, "shape": [4, 4], "y": 40, "x": 40, "type": "GridPlotContainer", "id": "83947888"}, "85648592": {"height": 85.0, "width": 115.0, "plots": {"hello": ["86205456"]}, "y": 330.0, "x": 330.0, "type": "Plot", "id": "85648592"}, "85430832": {"value_name": "petalWidth", "data_source": 81561648, "index_name": "sepalLength", "color_name": "species", "type": "ColormappedScatterPlot", "id": "85430832"}, "86877968": {"height": 85.0, "width": 115.0, "plots": {"hello": ["86988368"]}, "y": 175.0, "x": 175.0, "type": "Plot", "id": "86877968"}, "88332528": {"value_name": "sepalWidth", "data_source": 81561648, "index_name": "petalWidth", "color_name": "species", "type": "ColormappedScatterPlot", "id": "88332528"}, "83947984": {"height": 85.0, "width": 115.0, "plots": {"hello": ["83918672"]}, "y": 485.0, "x": 20.0, "type": "Plot", "id": "83947984"}, "87091248": {"height": 85.0, "width": 115.0, "plots": {"hello": ["87656304"]}, "y": 175.0, "x": 485.0, "type": "Plot", "id": "87091248"}, "83992944": {"height": 85.0, "width": 115.0, "plots": {"hello": ["84750512"]}, "y": 485.0, "x": 175.0, "type": "Plot", "id": "83992944"}, "88435120": {"value_name": "petalLength", "data_source": 81561648, "index_name": "petalWidth", "color_name": "species", "type": "ColormappedScatterPlot", "id": "88435120"}, "84857584": {"height": 85.0, "width": 115.0, "plots": {"hello": ["85430832"]}, "y": 485.0, "x": 485.0, "type": "Plot", "id": "84857584"}, "84750896": {"height": 85.0, "width": 115.0, "plots": {"hello": ["84857200"]}, "y": 485.0, "x": 330.0, "type": "Plot", "id": "84750896"}, "85431216": {"height": 85.0, "width": 115.0, "plots": {"hello": ["85529328"]}, "y": 330.0, "x": 20.0, "type": "Plot", "id": "85431216"}, "87090864": {"value_name": "petalLength", "data_source": 81561648, "index_name": "petalLength", "color_name": "species", "type": "ColormappedScatterPlot", "id": "87090864"}, "85529712": {"height": 85.0, "width": 115.0, "plots": {"hello": ["85648208"]}, "y": 330.0, "x": 175.0, "type": "Plot", "id": "85529712"}, "87771568": {"height": 85.0, "width": 115.0, "plots": {"hello": ["88332528"]}, "y": 20.0, "x": 175.0, "type": "Plot", "id": "87771568"}, "86205456": {"value_name": "petalLength", "data_source": 81561648, "index_name": "sepalWidth", "color_name": "species", "type": "ColormappedScatterPlot", "id": "86205456"}, "87771184": {"value_name": "sepalLength", "data_source": 81561648, "index_name": "petalWidth", "color_name": "species", "type": "ColormappedScatterPlot", "id": "87771184"}, "83918672": {"value_name": "sepalLength", "data_source": 81561648, "index_name": "sepalLength", "color_name": "species", "type": "ColormappedScatterPlot", "id": "83918672"}, "86877584": {"value_name": "sepalLength", "data_source": 81561648, "index_name": "petalLength", "color_name": "species", "type": "ColormappedScatterPlot", "id": "86877584"}, "84857200": {"value_name": "petalLength", "data_source": 81561648, "index_name": "sepalLength", "color_name": "species", "type": "ColormappedScatterPlot", "id": "84857200"}, "86320720": {"height": 85.0, "width": 115.0, "plots": {"hello": ["86877584"]}, "y": 175.0, "x": 20.0, "type": "Plot", "id": "86320720"}, "85529328": {"value_name": "sepalLength", "data_source": 81561648, "index_name": "sepalWidth", "color_name": "species", "type": "ColormappedScatterPlot", "id": "85529328"}, "85648208": {"value_name": "sepalWidth", "data_source": 81561648, "index_name": "sepalWidth", "color_name": "species", "type": "ColormappedScatterPlot", "id": "85648208"}, "87656688": {"height": 85.0, "width": 115.0, "plots": {"hello": ["87771184"]}, "y": 20.0, "x": 20.0, "type": "Plot", "id": "87656688"}, "86320336": {"value_name": "petalWidth", "data_source": 81561648, "index_name": "sepalWidth", "color_name": "species", "type": "ColormappedScatterPlot", "id": "86320336"}, "89262608": {"value_name": "petalWidth", "data_source": 81561648, "index_name": "petalWidth", "color_name": "species", "type": "ColormappedScatterPlot", "id": "89262608"}, "84750512": {"value_name": "sepalWidth", "data_source": 81561648, "index_name": "sepalLength", "color_name": "species", "type": "ColormappedScatterPlot", "id": "84750512"}, "88332912": {"height": 85.0, "width": 115.0, "plots": {"hello": ["88435120"]}, "y": 20.0, "x": 330.0, "type": "Plot", "id": "88332912"}, "88435504": {"height": 85.0, "width": 115.0, "plots": {"hello": ["89262608"]}, "y": 20.0, "x": 485.0, "type": "Plot", "id": "88435504"}, "86988752": {"height": 85.0, "width": 115.0, "plots": {"hello": ["87090864"]}, "y": 175.0, "x": 330.0, "type": "Plot", "id": "86988752"}, "86205840": {"height": 85.0, "width": 115.0, "plots": {"hello": ["86320336"]}, "y": 330.0, "x": 485.0, "type": "Plot", "id": "86205840"}, "86988368": {"value_name": "sepalWidth", "data_source": 81561648, "index_name": "petalLength", "color_name": "species", "type": "ColormappedScatterPlot", "id": "86988368"}, "87656304": {"value_name": "petalWidth", "data_source": 81561648, "index_name": "petalLength", "color_name": "species", "type": "ColormappedScatterPlot", "id": "87656304"}, "81561648": {"arrays": {"sepalLength": [5.1, 4.9, 4.7, 4.6, 5.0, 5.4, 4.6, 5.0, 4.4, 4.9, 5.4, 4.8, 4.8, 4.3, 5.8, 5.7, 5.4, 5.1, 5.7, 5.1, 5.4, 5.1, 4.6, 5.1, 4.8, 5.0, 5.0, 5.2, 5.2, 4.7, 4.8, 5.4, 5.2, 5.5, 4.9, 5.0, 5.5, 4.9, 4.4, 5.1, 5.0, 4.5, 4.4, 5.0, 5.1, 4.8, 5.1, 4.6, 5.3, 5.0, 7.0, 6.4, 6.9, 5.5, 6.5, 5.7, 6.3, 4.9, 6.6, 5.2, 5.0, 5.9, 6.0, 6.1, 5.6, 6.7, 5.6, 5.8, 6.2, 5.6, 5.9, 6.1, 6.3, 6.1, 6.4, 6.6, 6.8, 6.7, 6.0, 5.7, 5.5, 5.5, 5.8, 6.0, 5.4, 6.0, 6.7, 6.3, 5.6, 5.5, 5.5, 6.1, 5.8, 5.0, 5.6, 5.7, 5.7, 6.2, 5.1, 5.7, 6.3, 5.8, 7.1, 6.3, 6.5, 7.6, 4.9, 7.3, 6.7, 7.2, 6.5, 6.4, 6.8, 5.7, 5.8, 6.4, 6.5, 7.7, 7.7, 6.0, 6.9, 5.6, 7.7, 6.3, 6.7, 7.2, 6.2, 6.1, 6.4, 7.2, 7.4, 7.9, 6.4, 6.3, 6.1, 7.7, 6.3, 6.4, 6.0, 6.9, 6.7, 6.9, 5.8, 6.8, 6.7, 6.7, 6.3, 6.5, 6.2, 5.9], "petalWidth": [0.2, 0.2, 0.2, 0.2, 0.2, 0.4, 0.3, 0.2, 0.2, 0.1, 0.2, 0.2, 0.1, 0.1, 0.2, 0.4, 0.4, 0.3, 0.3, 0.3, 0.2, 0.4, 0.2, 0.5, 0.2, 0.2, 0.4, 0.2, 0.2, 0.2, 0.2, 0.4, 0.1, 0.2, 0.2, 0.2, 0.2, 0.1, 0.2, 0.2, 0.3, 0.3, 0.2, 0.6, 0.4, 0.3, 0.2, 0.2, 0.2, 0.2, 1.4, 1.5, 1.5, 1.3, 1.5, 1.3, 1.6, 1.0, 1.3, 1.4, 1.0, 1.5, 1.0, 1.4, 1.3, 1.4, 1.5, 1.0, 1.5, 1.1, 1.8, 1.3, 1.5, 1.2, 1.3, 1.4, 1.4, 1.7, 1.5, 1.0, 1.1, 1.0, 1.2, 1.6, 1.5, 1.6, 1.5, 1.3, 1.3, 1.3, 1.2, 1.4, 1.2, 1.0, 1.3, 1.2, 1.3, 1.3, 1.1, 1.3, 2.5, 1.9, 2.1, 1.8, 2.2, 2.1, 1.7, 1.8, 1.8, 2.5, 2.0, 1.9, 2.1, 2.0, 2.4, 2.3, 1.8, 2.2, 2.3, 1.5, 2.3, 2.0, 2.0, 1.8, 2.1, 1.8, 1.8, 1.8, 2.1, 1.6, 1.9, 2.0, 2.2, 1.5, 1.4, 2.3, 2.4, 1.8, 1.8, 2.1, 2.4, 2.3, 1.9, 2.3, 2.5, 2.3, 1.9, 2.0, 2.3, 1.8], "sepalWidth": [3.5, 3.0, 3.2, 3.1, 3.6, 3.9, 3.4, 3.4, 2.9, 3.1, 3.7, 3.4, 3.0, 3.0, 4.0, 4.4, 3.9, 3.5, 3.8, 3.8, 3.4, 3.7, 3.6, 3.3, 3.4, 3.0, 3.4, 3.5, 3.4, 3.2, 3.1, 3.4, 4.1, 4.2, 3.1, 3.2, 3.5, 3.6, 3.0, 3.4, 3.5, 2.3, 3.2, 3.5, 3.8, 3.0, 3.8, 3.2, 3.7, 3.3, 3.2, 3.2, 3.1, 2.3, 2.8, 2.8, 3.3, 2.4, 2.9, 2.7, 2.0, 3.0, 2.2, 2.9, 2.9, 3.1, 3.0, 2.7, 2.2, 2.5, 3.2, 2.8, 2.5, 2.8, 2.9, 3.0, 2.8, 3.0, 2.9, 2.6, 2.4, 2.4, 2.7, 2.7, 3.0, 3.4, 3.1, 2.3, 3.0, 2.5, 2.6, 3.0, 2.6, 2.3, 2.7, 3.0, 2.9, 2.9, 2.5, 2.8, 3.3, 2.7, 3.0, 2.9, 3.0, 3.0, 2.5, 2.9, 2.5, 3.6, 3.2, 2.7, 3.0, 2.5, 2.8, 3.2, 3.0, 3.8, 2.6, 2.2, 3.2, 2.8, 2.8, 2.7, 3.3, 3.2, 2.8, 3.0, 2.8, 3.0, 2.8, 3.8, 2.8, 2.8, 2.6, 3.0, 3.4, 3.1, 3.0, 3.1, 3.1, 3.1, 2.7, 3.2, 3.3, 3.0, 2.5, 3.0, 3.4, 3.0], "petalLength": [1.4, 1.4, 1.3, 1.5, 1.4, 1.7, 1.4, 1.5, 1.4, 1.5, 1.5, 1.6, 1.4, 1.1, 1.2, 1.5, 1.3, 1.4, 1.7, 1.5, 1.7, 1.5, 1.0, 1.7, 1.9, 1.6, 1.6, 1.5, 1.4, 1.6, 1.6, 1.5, 1.5, 1.4, 1.5, 1.2, 1.3, 1.4, 1.3, 1.5, 1.3, 1.3, 1.3, 1.6, 1.9, 1.4, 1.6, 1.4, 1.5, 1.4, 4.7, 4.5, 4.9, 4.0, 4.6, 4.5, 4.7, 3.3, 4.6, 3.9, 3.5, 4.2, 4.0, 4.7, 3.6, 4.4, 4.5, 4.1, 4.5, 3.9, 4.8, 4.0, 4.9, 4.7, 4.3, 4.4, 4.8, 5.0, 4.5, 3.5, 3.8, 3.7, 3.9, 5.1, 4.5, 4.5, 4.7, 4.4, 4.1, 4.0, 4.4, 4.6, 4.0, 3.3, 4.2, 4.2, 4.2, 4.3, 3.0, 4.1, 6.0, 5.1, 5.9, 5.6, 5.8, 6.6, 4.5, 6.3, 5.8, 6.1, 5.1, 5.3, 5.5, 5.0, 5.1, 5.3, 5.5, 6.7, 6.9, 5.0, 5.7, 4.9, 6.7, 4.9, 5.7, 6.0, 4.8, 4.9, 5.6, 5.8, 6.1, 6.4, 5.6, 5.1, 5.6, 6.1, 5.6, 5.5, 4.8, 5.4, 5.6, 5.1, 5.1, 5.9, 5.7, 5.2, 5.0, 5.2, 5.4, 5.1], "species": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2]}, "tools": "select", "type": "ArrayPlotData", "id": "81561648"}};
window.main_id = "83947888";
Backbone.create_or_get = function(collection, attributes){
	var obj = null;
	if (attributes['id']){
	    if(collection.get(attributes['id'])){
		obj = collection.get(attributes['id']);
	    }
	}
	if (!obj){
	    obj = collection.create(attributes);
	}
	return obj;
}

_.uniqueId = function (prefix) {
    //from ipython project
    // http://www.ietf.org/rfc/rfc4122.txt
    var s = [];
    var hexDigits = "0123456789ABCDEF";
    for (var i = 0; i < 32; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
    }
    s[12] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
    s[16] = hexDigits.substr((s[16] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
    var uuid = s.join("");
    return prefix + "-" + uuid;
};

window.default_render_namespace = {}
window.default_namespace = {}
chaco = {}
chaco.datasource_from_data = function(namespace, all_objs, obj_id){
    var obj = all_objs[obj_id];
    var obj_type = obj['type']
    var model;
    var collection;
    if (obj_type === 'ArrayPlotData'){
	if (!namespace['ArrayPlotDatas']){
	    namespace['ArrayPlotDatas'] = new chaco.ArrayPlotDatas()
	}
	collection = namespace['ArrayPlotDatas'];
	model = Backbone.create_or_get(collection, obj);
    }
    return {'collection' : collection,
	    'model' : model}
}

chaco.from_data = function(render_namespace, all_objs, obj_id, el){
    var obj = all_objs[obj_id];
    var obj_type = obj['type']
    var model;
    var collection;
    var view;
    if (obj_type ==='GridPlotContainer'){
	if (!render_namespace['GridPlotContainers']){
	    render_namespace['GridPlotContainers'] = new chaco.GridPlotContainers();
	}
	collection = render_namespace['GridPlotContainers'];
	model = Backbone.create_or_get(collection, obj);
	args = {'collection' : collection,
		'model' : model};
	if(el){args['el'] = el}
	view = new chaco.GridPlotContainerView(args);

    }else if (obj_type == 'Plot'){
	obj = _.clone(obj);
	var sub_plot_id = _.values(obj['plots'])[0];
	var sub_obj = _.clone(all_objs[sub_plot_id]);
	if (sub_obj['type'] === 'ColormappedScatterPlot'){
	    _.extend(obj, sub_obj);
	    if (!render_namespace['ColormappedScatterPlots']){
		render_namespace['ColormappedScatterPlots'] = new chaco.ColormappedScatterPlots();
	    }
	    collection = render_namespace['ColormappedScatterPlots'];
	    model = Backbone.create_or_get(collection, obj);
	    args = {'collection' : collection,
		    'model' : model};
	    if(el){args['el'] = el}
	    view = new chaco.ColormappedScatterPlotview(args);
	}
    }
    return {'collection' : collection,
	    'model' : model,
	    'view' : view}
}
//grid plot container model collection view
chaco.GridPlotContainer = Backbone.Model.extend({
    initialize : function(attributes, options){
	if (!attributes['id']){
	    this.set({'id' : _.uniqueId('view')}, 
		     {silent : true})
	}
    },
    defaults : {
	'shape' : [],
	'component_grid' : [[]],
	'height' :  0,
	'width' :  0,
    }
});

chaco.GridPlotContainers = Backbone.Collection.extend({
    model : chaco.GridPlotContainer,
    url : "/",
    localStorage : new Store('GridPlotContainers', true)

});

chaco.GridPlotContainerView = Backbone.View.extend({
    initialize : function(options){
	if (!options['id']){
	    this.id  = _.uniqueId('view');
	}
    },
    render : function(){
	var that = this;
	this.$el = $(this.el);
	this.$el.height(this.model.get('height'));
	this.$el.width(this.model.get('width'));
	_.each(this.model.get('component_grid'), function(row){
	    var rowdiv = $("<div class='row'></div>");
	    that.$el.append(rowdiv);
	    _.each(row, function(objid){
		results = chaco.from_data(window.default_render_namespace,
					  window.export_data, 
					  objid);
		results['view'].render();
		rowdiv.append(results['view'].$el);
	    });
	    that.$el.append($("<br/>"));
	});
    }
});

//color mapped scatter plot model, collection, view
chaco.ColormappedScatterPlot = Backbone.Model.extend({
    initialize : function(attributes, options){
	if (!attributes['id']){
	    this.set({'id' : _.uniqueId('view')}, 
		     {silent : true})
	}
	if (this.get('data_source')){
	    var source = chaco.datasource_from_data(
		window.default_namespace, 
		export_data, 
		this.get('data_source'))
	    source = source['model'];
	    source.on('change', function(){this.trigger('change')});
	    this.set({'data_source_model' : source});
	}
    },
    get_data : function(name){
	return this.get('data_source_model').get('arrays')[name];
    },
    defaults : {
	'height' :  0,
	'width' :  0,
	'color_name' : '',
	'index_name' : '',
	'value_name' : '',
	'data_source' : null
    },
    render : function(){
	
    }
});
chaco.ColormappedScatterPlots = Backbone.Collection.extend({
    model : chaco.ColormappedScatterPlot,
    url : "/",
    localStorage : new Store('ColormappedScatterPlots', true)
});
chaco.linear_axes = function(data, display_size, reverse){
    var domain, range
    domain = [d3.min(data), d3.max(data)];
    if (reverse){
	range = [0, display_size];
    }else{
	range = [display_size, 0];
    }
    return d3.scale.linear().domain(domain).range(range);
}
chaco.ColormappedScatterPlotview = Backbone.View.extend({
    initialize : function(options){
	if (!options['id']){
	    this.id  = _.uniqueId('view');
	}
	//axes objects
	var that = this;
	var model = this.model;
	var arrays = model.get('arrays');
	this.index_axis = chaco.linear_axes(
	    model.get_data(model.get('index_name')),
	    model.get('width'),
	    false);
	this.range_axis = chaco.linear_axes(
	    model.get_data(model.get('value_name')),
			   model.get('height'),
			   true);
    },
    render : function(){
	var model = this.model;
	var svg = d3.select(this.el).append('svg')
	    .attr('width', model.get('width'))
	    .attr('height', model.get('height'));
	svg.append('rect')
	    .attr("class", "frame")
	    .attr("width", model.get('width'))
	    .attr("height", model.get('height'));
	this.$el.addClass('plot');
	this.$el.css({ 'position' : 'absolute', 
		       'bottom' : model.get('x') + 'px', 
		       'left' : model.get('y') + 'px'});
	var that = this;
	svg.selectAll('circle')
	    .data(model.get('data_source_model').to_d3())
	    .enter().append('circle')
	    .attr('class', function(d){
		return "" + d[model.get('color_name')];
	    })
	    .attr('cx', function(d){
		return that.index_axis(d[model.get('index_name')]);
	    })
	    .attr('cy', function(d){
		return that.range_axis(d[model.get('value_name')]);
	    })
	    .attr('r', 3);
	console.log(['sdfsdfds']);
    },
});

//ArrayPlotData collection and model
chaco.ArrayPlotData = Backbone.Model.extend({
    initialize : function(attributes, options){
	if (!attributes['id']){
	    this.set({'id' : _.uniqueId('view')}, 
		     {silent : true})
	}
	var that = this;
	this.bind('change:arrays', function(){
	    delete that['_to_d3'];
	});
    },
    to_d3 : function(force){
	//go from bunch of arrays to array of dicts
	if (!force && this._to_d3){
	    return this._to_d3
	}else{
	    data = []
	    _.each(this.get('arrays'), function(array, k){
		_.each(array, function(val, idx){
		    if(!data[idx]){
			data[idx] = {};
		    }
		    data[idx][k] = val;
		});
	    });
	    this._to_d3 = data;
	    return this._to_d3;
	}
    }
});

chaco.ArrayPlotDatas = Backbone.Collection.extend({
    model : chaco.ArrayPlotData,
    url : "/",
    localStorage : new Store('ArrayPlotDatas', true)
});

$(function(){
    results = chaco.from_data(window.default_render_namespace,
			      window.export_data, 
			      window.main_id, 
			      $('#chart')[0]);
    results['view'].render();
});
